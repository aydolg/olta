<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Karadeniz Av Rehberi</title>
<style>
  /* GENEL STÄ°LLER VE KARTLAR */
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  body,html{height:100%;background:#0c1e36;color:#fff;font-family:system-ui,sans-serif;overflow:hidden}
  
  /* HEADER SADELEÅTÄ°RÄ°LDÄ° */
  .header{background:#00ff9d;color:#000;padding:16px;font-weight:900;text-align:center;position:fixed;top:0;left:0;right:0;z-index:1000;box-shadow:0 4px 4px rgba(0,255,157,.4)}
  
  #map{height:35vh; width:100%;position: relative; top: 52px;}
  .content{position:absolute;top:calc(35vh + 52px); left:0; right:0; bottom:0; overflow-y:auto;-webkit-overflow-scrolling:touch;background:#0c1e36}
  .card{background:rgba(255,255,255,.08);backdrop-filter:blur(16px);border-radius:20px 20px 0 0;margin:0;padding:20px 16px 30px;box-shadow:0 -10px 40px rgba(0,0,0,.7)}
  .konum{font-size:24px;color:#00ff9d;font-weight:900;margin-bottom:8px;text-shadow:0 0 12px #00ff9d}
  
  /* TARÄ°H SEÃ‡Ä°CÄ° */
  input[type=date]{width:270px;padding:14px 20px;font-size:19px;border:none;border-radius:16px;background:#16213e;color:#fff;box-shadow:0 6px 25px #0008;display:block;margin:10px auto 16px auto;}

  /* SOLUNAR KARTI */
  .solunar{background:#16213e;padding:20px;border-radius:18px;margin:18px 0}
  .solunar h3{font-size:20px;color:#00ff9d;font-weight:900;text-align:center;margin-bottom:16px}
  
  /* GRAFÄ°K VE 24 SAATLÄ°K BÃ–LÃœMÃœ */
  .grafik-konteyner{
    border: 1px solid rgba(255, 255, 255, 0.1);border-radius: 12px;background: #0b1a2e;margin-bottom: 20px;
    display: flex; flex-direction: column;
  }
  .grafik{height:60px;position:relative;overflow:hidden;padding:10px 0; display:flex; justify-content: space-around;} 
  
  /* EMOJÄ° KONTEYNERÄ° */
  .emoji-container{flex-basis: calc(100% / 24); text-align:center;font-size:14px;opacity:0.9;text-shadow: 0 0 5px rgba(0,0,0,0.5);line-height: 40px; height: 40px;margin: 0;padding: 0;border-right: 1px solid rgba(255, 255, 255, 0.2);}
  .emoji-container:last-child {border-right: none;}

  /* 24 SAATLÄ°K DÄ°LÄ°MLER ve ETÄ°KETLER */
  .saatlik-grid{display:grid;grid-template-columns:repeat(24,1fr); gap:0px; height:25px;text-align:center;background:rgba(255,255,255,0.05);border-top: 1px solid rgba(255, 255, 255, 0.1);border-radius: 0 0 12px 12px;}
  .saat-etiket-sutun{font-size:9px; line-height:25px;opacity:0.8;border-right: 1px solid rgba(255, 255, 255, 0.2);}
  .saat-etiket-sutun:last-child {border-right: none;}

  /* ORTALAMA PUAN KUTUSU */
  .ortalama-puan-kutu {background: rgba(0,255,157,0.1);border-radius: 12px;padding: 15px;text-align: center;margin-bottom: 15px;border: 1px solid #00ff9d;}
  .ortalama-puan-kutu strong {display: block;font-size: 36px;color: #00ff9d;font-weight: 900;}
  .ortalama-puan-kutu span {font-size: 14px;opacity: 0.8;}

  /* BÄ°LGÄ° KARTLARI */
  .karti{padding:18px;border-radius:18px;margin:18px 0;background:linear-gradient(135deg,#1e3c72,#2a5298)}
  .karti.deniz{background:linear-gradient(135deg,#0f2027,#203a43)}
  .karti.solunar-zaman{background:linear-gradient(135deg,#4e3c72,#5a5298)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;text-align:center}
  .item{background:rgba(255,255,255,.12);padding:14px;border-radius:14px}
  .item strong{font-size:21px;display:block}
  
  /* BALIK TEKNÄ°KLERÄ° VE PUAN RENKLERÄ° */
  .balik-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:30px 0}
  .balik{background:#16213e;padding:16px;border-radius:16px;text-align:center;cursor:pointer;transition:.3s;border:1px solid rgba(0,255,157,.15)}
  .balik:hover{transform:scale(1.1);background:#1e2d4a;box-shadow:0 10px 30px rgba(0,255,157,.4)}
  .balik h3{margin:0 0 6px;font-size:16px;color:#00ff9d}
  .durum{font-size:15px;font-weight:900}
  
  /* YENÄ° PUAN RENKLERÄ° (UX Ä°yileÅŸtirmesi) */
  .cok-yuksek{color:#ff2600} /* KÄ±rmÄ±zÄ± */
  .yuksek{color:#00ff9d} /* YeÅŸil */
  .orta{color:#ffc107} /* SarÄ± */
  .dÃ¼ÅŸÃ¼k{color:#b3b3b3} /* Gri/AÃ§Ä±k KÄ±rmÄ±zÄ± (DÃ¼ÅŸÃ¼k aktivite) */

  .teknik{display:none;background:#0a1e33;padding:30px;border-radius:24px;margin:30px 0;border:3px solid #00ff9d66;line-height:2.2;font-size:17px; text-align:left;}
  .teknik.active{display:block}
  .teknik .baslik{font-size:28px;color:#00ff9d;font-weight:900;display:block;margin-bottom:20px;text-align:center;}
  .teknik strong {color: #00ff9d; display: block; margin-top: 10px;}
  .teknik li {margin-left: 25px; list-style-type: disc;}
  .teknik ul{margin-bottom: 10px;}

  /* YÃœKLENÄ°YOR (LOADING) */
  .loading .card{opacity:0.5;pointer-events:none;}
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>

<div class="header">Karadeniz BalÄ±k AvÄ± Rehberi ğŸŸ</div>
<div id="map"></div>
<div class="content">
  <div class="card" id="info">
    <div style="text-align:center; padding:100px 0; font-size:24px; color:#00ff9d;">Veriler YÃ¼kleniyor... â³</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// TÃ¼m uygulama mantÄ±ÄŸÄ± IIFE (Immediately Invoked Function Expression) iÃ§ine alÄ±nmÄ±ÅŸtÄ±r.
(function() {
    // Sabitler
    const API_KEY = "13dda88cd89bad8dfb00130704d2d2e4"; // LÃ¼tfen kendi API anahtarÄ±nÄ±zÄ± buraya giriniz!
    const BARTIN = [41.634, 32.335];

    // Uygulama DeÄŸiÅŸkenleri
    let lat = BARTIN[0];
    let lon = BARTIN[1];
    let tarih = new Date();
    let map, marker, debouncedGuncelle;
    
    // IDEAL KOÅULLAR
    const IDEAL_KOÅULLAR = {
        // BalÄ±k TÃ¼rleri - [SÄ±caklÄ±k], [BasÄ±nÃ§], [RÃ¼zgar], [Dalga] AralÄ±ÄŸÄ± ve AÄŸÄ±rlÄ±klarÄ± (weightT/P/W/H)
        "LÃ¼fer": { temp: [14, 22], weightT: 1.5, pressure: [1010, 1025], weightP: 1.3, windSpeed: [5, 15], weightW: 1.0, waveHeight: [0.4, 1.2], weightH: 0.8 },
        "Levrek": { temp: [10, 18], weightT: 1.6, pressure: [1005, 1018], weightP: 1.0, windSpeed: [4, 12], weightW: 1.2, waveHeight: [0.3, 0.8], weightH: 1.8 }, 
        "Ä°stavrit": { temp: [18, 26], weightT: 1.8, pressure: [1015, 1030], weightP: 1.4, windSpeed: [0, 8], weightW: 1.0, waveHeight: [0.0, 0.3], weightH: 1.0 }, 
        "Mezgit": { temp: [4, 12], weightT: 1.7, pressure: [1010, 1025], weightP: 0.8, windSpeed: [5, 15], weightW: 1.0, waveHeight: [0.5, 1.5], weightH: 0.9 }, 
        "Kalkan": { temp: [8, 16], weightT: 1.2, pressure: [1008, 1020], weightP: 1.0, windSpeed: [7, 18], weightW: 1.3, waveHeight: [0.6, 1.8], weightH: 1.5 }, 
        "Zargana": { temp: [16, 24], weightT: 1.4, pressure: [1010, 1022], weightP: 1.0, windSpeed: [3, 10], weightW: 0.9, waveHeight: [0.2, 0.7], weightH: 1.1 },
        "SarÄ±kanat": { temp: [14, 22], weightT: 1.5, pressure: [1010, 1025], weightP: 1.3, windSpeed: [5, 15], weightW: 1.0, waveHeight: [0.4, 1.2], weightH: 0.8 }, 
        "Kefal": { temp: [18, 28], weightT: 1.5, pressure: [1015, 1030], weightP: 1.8, windSpeed: [0, 5], weightW: 1.7, waveHeight: [0.0, 0.2], weightH: 1.9 }, 
        "Barbun": { temp: [15, 22], weightT: 1.3, pressure: [1008, 1020], weightP: 1.2, windSpeed: [3, 10], weightW: 1.0, waveHeight: [0.4, 1.0], weightH: 1.1 }, 
        "Ä°zmarit": { temp: [12, 20], weightT: 1.4, pressure: [1010, 1025], weightP: 1.3, windSpeed: [0, 8], weightW: 1.0, waveHeight: [0.1, 0.5], weightH: 0.9 }, 
        "Sargoz": { temp: [16, 24], weightT: 1.5, pressure: [1005, 1018], weightP: 1.1, windSpeed: [5, 15], weightW: 1.2, waveHeight: [0.5, 1.5], weightH: 1.4 }, 
        "KÄ±rlangÄ±Ã§": { temp: [8, 16], weightT: 1.6, pressure: [1010, 1025], weightP: 1.0, windSpeed: [5, 15], weightW: 1.1, waveHeight: [0.5, 1.5], weightH: 1.3 }, 
    };

    // BalÄ±k Av Teknikleri (DetaylÄ± Ekipman Bilgisi Eklendi)
    const teknikler={ 
        "LÃ¼fer":`
            <span class="baslik">LÃœFER â€“ SPIN (AT-Ã‡EK) AV TEKNÄ°KLERÄ°</span>
            <strong>Ekipman Ã–nerileri:</strong>
            <ul><li>**KamÄ±ÅŸ:** 270-300 cm, 15-45 gr atarlÄ± (MH aksiyon).</li>
            <li>**Makine:** 3000-4000 boy (HÄ±zlÄ± devir, 90+ cm sarÄ±m).</li>
            <li>**Misina:** 0.12-0.16 mm 8X Ä°p Misina + **0.30-0.35 mm Florokarbon Lider**.</li></ul>
            <strong>Yem ve Aksiyon:</strong>
            <ul><li>**Sahte Yem:** 9-14 cm Minnow (Suspending/Floating), Popper, KaÅŸÄ±k.</li>
            <li>**Yemli:** MantarlÄ± dip takÄ±mÄ±, Zoka. Taze Zargana/Ä°stavrit filetosu.</li>
            <li>**Aksiyon:** KamÄ±ÅŸ ucu aÅŸaÄŸÄ±da, hÄ±zlÄ± sarÄ±m arasÄ±na ani duraksamalar (Stop and Go).</li></ul>
        `,
        "Levrek":`
            <span class="baslik">LEVREK â€“ SPIN VE LRF TEKNÄ°KLERÄ°</span>
            <strong>Spin (At-Ã‡ek) EkipmanÄ±:</strong>
            <ul><li>**KamÄ±ÅŸ:** 240-270 cm, 7-35 gr atarlÄ± (ML/M aksiyon).</li>
            <li>**Misina:** 0.10-0.14 mm Ä°p + **0.25-0.30 mm FC Lider**.</li>
            <li>**Yem:** 11-13 cm Suspending/Floating Minnow (bulanÄ±k suda Sinking), YÃ¼zey Sahtesi (Popper/Walker).</li></ul>
            <strong>LRF (Hafif AvcÄ±lÄ±k) EkipmanÄ±:</strong>
            <ul><li>**KamÄ±ÅŸ:** 180-225 cm, 1-10 gr atarlÄ±.</li>
            <li>**Makine:** 1000-2000 boy.</li>
            <li>**Yem:** 3-7 cm kÃ¼Ã§Ã¼k Shad silikon, Solucan silikon.</li></ul>
        `,
        "Ä°stavrit":`
            <span class="baslik">Ä°STAVRÄ°T â€“ Ã‡APARÄ° VE HAFÄ°F JIGGING</span>
            <strong>Ã‡apari TakÄ±mÄ±:</strong>
            <ul><li>**KamÄ±ÅŸ:** 330-420 cm Surf KamÄ±ÅŸ (KÄ±yÄ±dan atÄ±ÅŸ iÃ§in) veya Tekne KamÄ±ÅŸÄ±.</li>
            <li>**TakÄ±m:** **10-25 kÃ¶stekli Ä°stavrit Ã‡aparisi**. KÃ¶stekler 0.25-0.30 mm.</li>
            <li>**Ä°ÄŸne:** 6-10 numara, kalaylÄ± veya sinek iÄŸne. TÃ¼ylerde simli/parlak renkler (SarÄ±/Beyaz/YeÅŸil).</li>
            <li>**KurÅŸun:** KÄ±yÄ±dan 150-250 gr, tekneden 60-120 gr armut/yaprak kurÅŸun (AkÄ±ntÄ±ya gÃ¶re ayarlanÄ±r).</li></ul>
        `,
        "Mezgit":`
            <span class="baslik">MEZGÄ°T â€“ KIÅ DÄ°P AV TEKNÄ°KLERÄ°</span>
            <strong>Sistem ve TakÄ±m:</strong>
            <ul><li>**TakÄ±m:** Paternoster (uzun kÃ¶stekli) veya klasik iki kÃ¶stekli dip takÄ±mÄ±.</li>
            <li>**KÃ¶stek:** 0.25-0.30 mm kalÄ±nlÄ±k, 40-60 cm uzunluk.</li>
            <li>**Ä°ÄŸne:** 4-6 numara uzun pala iÄŸneler.</li>
            <li>**Yem:** **Boru Kurdu** (SÃ¼lÃ¼nez), Karides, Taze Midye Ä°Ã§i.</li>
            <li>**Konum:** SoÄŸuk suda kÄ±yÄ±ya yakÄ±n, kumlu-Ã§amurlu dipler.</li></ul>
        `,
        "Kalkan":`
            <span class="baslik">KALKAN â€“ DÄ°P AV TEKNÄ°KLERÄ° (Kumlu Dip)</span>
            <strong>Ekipman SeÃ§imi:</strong>
            <ul><li>**KamÄ±ÅŸ:** 100-200 gr atarlÄ± Surf/Tekne kamÄ±ÅŸÄ± (GÃ¼Ã§lÃ¼).</li>
            <li>**Misina:** Beden 0.50-0.70 mm, KÃ¶stek **0.35-0.40 mm**.</li>
            <li>**Ä°ÄŸne:** 1/0 - 3/0 arasÄ± saÄŸlam iÄŸneler.</li>
            <li>**KurÅŸun:** 150-250 gr **Piramit KurÅŸun** (Kumda gÃ¶mÃ¼lÃ¼p sabit durmasÄ± iÃ§in).</li>
            <li>**Yem:** Taze ve canlÄ± **Ä°stavrit Filetosu**, Hamsi veya kÃ¼Ã§Ã¼k kefal.</li></ul>
        `,
        "Zargana":`
            <span class="baslik">ZARGANA â€“ YÃœZEY VE Ä°PEK TEKNÄ°ÄÄ°</span>
            <strong>YÃ¶ntemler ve Ekipman:</strong>
            <ul><li>**ÅamandÄ±ralÄ± Yemli:** Gezer ÅŸamandÄ±ralÄ±, hafif tek iÄŸneli takÄ±m. Yem olarak **Ä°stavrit/Hamsi ÅŸerit yem**.</li>
            <li>**Ä°pek AvÄ±:** Ä°ÄŸnesiz, turuncu/sarÄ± renkli ipek takÄ±mÄ± (Raglou tarzÄ±). At-Ã§ek aksiyonu ile ipeÄŸe sarÄ±lmasÄ± saÄŸlanÄ±r.</li>
            <li>**Spin:** 5-6 cm beyaz simli silikonlar veya ufak kaÅŸÄ±klar.</li>
            <li>**Kritik:** Yemi takip ediyorsa sarÄ±m hÄ±zÄ±nÄ± deÄŸiÅŸtirerek ani duraksamalar yapÄ±n.</li></ul>
        `,
        "SarÄ±kanat":`
            <span class="baslik">SARIKANAT â€“ SPIN (AT-Ã‡EK) TEKNÄ°ÄÄ°</span>
            <strong>Ekipman Odak:</strong>
            <ul><li>**KamÄ±ÅŸ:** 240-270 cm, 7-35 gr atarlÄ±, hassas uÃ§lu Spin kamÄ±ÅŸÄ±.</li>
            <li>**Misina:** 0.10-0.12 mm Ä°p misina (Ä°nce takÄ±m avcÄ±lÄ±ÄŸÄ± artÄ±rÄ±r).</li>
            <li>**Yem:** **7-10 cm Sinking/Suspending Minnow** veya kÃ¼Ã§Ã¼k Jig (10-25 gr).</li>
            <li>**Aksiyon:** HÄ±zlÄ± ve agresif sarÄ±m. Ã–zellikle akarsu aÄŸÄ±zlarÄ± ve dalgalÄ± sular hedeflenmeli.</li></ul>
        `,
        "Kefal":`
            <span class="baslik">KEFAL â€“ ÅAMANDIRA VE SARMA TEKNÄ°KLERÄ°</span>
            <strong>Ekipman ve TakÄ±m:</strong>
            <ul><li>**KamÄ±ÅŸ/Makine:** Hafif ve esnek, ince takÄ±mlar tercih edin.</li>
            <li>**TakÄ±m:** Gezer ÅŸamandÄ±ralÄ± tek iÄŸneli takÄ±m veya Sarma olta (Ã§ok iÄŸneli).</li>
            <li>**Misina:** 0.15-0.20 mm (Kefal kurnaz ve narin dudaklÄ±dÄ±r).</li>
            <li>**Yem:** **Ekmek Ä°Ã§i/Hamur**, Tavuk Eti, KurtÃ§uk (Solucan), Midye Ä°Ã§i.</li>
            <li>**Teknik:** Yemi didiklediÄŸi iÃ§in yutana kadar tasmalamayÄ± bekleyin.</li></ul>
        `,
        "Barbun":`
            <span class="baslik">BARBUN â€“ DÄ°P (MOMENTO) AV TEKNÄ°KLERÄ°</span>
            <strong>Ekipman ve Yem:</strong>
            <ul><li>**TakÄ±m:** Ä°ki/ÃœÃ§ kÃ¶stekli yemli dip takÄ±mÄ±.</li>
            <li>**Misina:** Ana Beden 0.30-0.35 mm, KÃ¶stek **0.20-0.28 mm Mono Misina**.</li>
            <li>**Ä°ÄŸne:** 7-9 numara **Ã‡apraz/KÄ±rmÄ±zÄ±** renkli iÄŸneler (Dipte dikkat Ã§ekmesi iÃ§in).</li>
            <li>**KurÅŸun:** 75-120 gr (AkÄ±ntÄ±ya gÃ¶re).</li>
            <li>**Yem:** Taze **Karides** (Ã‡imÃ§im), Boru Kurdu, SÃ¼lÃ¼nez, Tavuk GÃ¶ÄŸsÃ¼.</li></ul>
        `,
        "Ä°zmarit":`
            <span class="baslik">Ä°ZMÄ°RÄ°T â€“ KIYI SAVURMA (DÄ°P)</span>
            <strong>Ekipman ve TakÄ±m:</strong>
            <ul><li>**TakÄ±m:** ÃœÃ§ kÃ¶stekli dip takÄ±mÄ± (KÄ±yÄ±dan savurma iÃ§in kÃ¶stek boylarÄ± uzun olmalÄ±).</li>
            <li>**Misina:** Beden 0.35 mm, KÃ¶stek **0.18-0.20 mm** (Ä°nce takÄ±m Ã§ok avcÄ±dÄ±r).</li>
            <li>**Ä°ÄŸne:** 9-14 numara sinek iÄŸneler.</li>
            <li>**Yem:** **Midye Ä°Ã§i**, Teke, Mamun, BalÄ±k Eti (gÃ¶ÄŸÃ¼s kÄ±smÄ±).</li>
            <li>**Kritik:** GÃ¼neÅŸ battÄ±ktan sonra av kesilir. Sabah saatleri verimlidir.</li></ul>
        `,
        "Sargoz":`
            <span class="baslik">SARGOZ â€“ KAYALIK DÄ°P VE LRF</span>
            <strong>TakÄ±m ve Yemler:</strong>
            <ul><li>**TakÄ±m:** Yemli dip takÄ±mÄ± (TaÅŸlÄ±k ve kayalÄ±k merada takÄ±lma riski yÃ¼ksek).</li>
            <li>**Misina:** **0.25-0.30 mm** (Kayalara sÃ¼rtÃ¼nmeye dayanÄ±klÄ± olmalÄ±).</li>
            <li>**Yem:** **Mamun, SÃ¼lÃ¼nez, CanlÄ± Teke, Midye**. (Sert yemler: Kalamar, SÃ¼bye).</li>
            <li>**LRF:** 5-10 gr jighead ve deniz hÄ±yarÄ± veya kurtÃ§uk imitasyonu silikon.</li>
            <li>**Hedef:** TaÅŸlÄ±k ve meralarÄ±n dibi, liman iÃ§leri.</li></ul>
        `,
        "KÄ±rlangÄ±Ã§":`
            <span class="baslik">KIRLANGIÃ‡ â€“ DERÄ°N DÄ°P AV (TEKNE)</span>
            <strong>Ekipman Odak:</strong>
            <ul><li>**YÃ¶ntem:** Tekne avcÄ±lÄ±ÄŸÄ± (BÄ±rakma/ÅakÅŸak).</li>
            <li>**KamÄ±ÅŸ:** GÃ¼Ã§lÃ¼, 150-300 gr atarlÄ± teknede kullanÄ±lan kÄ±sa kamÄ±ÅŸlar.</li>
            <li>**KurÅŸun:** 150-300 gr aÄŸÄ±rlÄ±ÄŸÄ±nda.</li>
            <li>**Misina/KÃ¶stek:** 0.35-0.45 mm arasÄ± saÄŸlam misina.</li>
            <li>**Yem:** **Kalamar parÃ§asÄ±**, Taze Karides veya Taze Hamsi/Ä°stavrit filetosu.</li></ul>
        `,
    };

    // YardÄ±mcÄ± Fonksiyonlar (Ã–nceki Koddan)
    const debounce = (func, delay) => {
        let timeoutId;
        return (...args) => {
            if (timeoutId) {clearTimeout(timeoutId);}
            timeoutId = setTimeout(() => {func.apply(null, args);}, delay);
        };
    };
    const yon = d => ["K", "KB", "B", "GB", "G", "GD", "D", "KD"][Math.round(d / 45) % 8];
    const formatSolunarTime = h => {
        const hours = Math.floor(h);
        const minutes = Math.round((h - hours) * 60);
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    };
    const solunar = t => {
        const g = (t - new Date("2000-01-06")) / 864e5;
        const m = (218.316 + 13.176396 * g) % 360;
        const s = (280.466 + 0.9856474 * ((t - new Date("2000-01-01")) / 864e5)) % 360;
        let f = (m - s + 360) % 360;
        if (f > 180) f -= 360;
        const maj1 = ((f / 15) + 2 + 24) % 24; const maj2 = (maj1 + 12) % 24;        
        const min1 = (maj1 + 6) % 24; const min2 = (maj1 + 18) % 24;        
        return { maj1, maj2, min1, min2, ay: Math.round((f + 180) / 3.6) };
    };
    const gelgit = t => {
        const h = t.getTime() / 36e5;
        const cm = Math.round(Math.sin(h * .52) * 18 + Math.cos(h * .38) * 8 + 32);
        return { seviye: (cm / 100).toFixed(2), trend: Math.cos(h * .52) > 0 ? "YÃ¼kseliyor" : "DÃ¼ÅŸÃ¼yor" };
    };
    const getFishEmojis = (hour, m1, m2, n1, n2, returnWeight = false) => {
        let count = 0;
        if (Math.abs(hour - m1) < 1.5 || Math.abs(hour - m2) < 1.5) {count = 3;} 
        else if (Math.abs(hour - n1) < 1 || Math.abs(hour - n2) < 1) {count = 2;} 
        else if (Math.abs(hour - n1) < 2 || Math.abs(hour - n2) < 2) {count = 1;}
        if (returnWeight) return count;
        if (count === 3) return "ğŸŸğŸŸğŸŸ";
        if (count === 2) return "ğŸŸğŸŸ";
        if (count === 1) return "ğŸŸ";
        return "";
    };

    const calculateFactorMultiplier = (current, ideal) => {
        const [min, max] = ideal;
        if (current >= min && current <= max) {return 1.2;}
        const midpoint = (min + max) / 2;
        const range = (max - min) / 2;
        const distance = Math.abs(current - midpoint);
        const max_deviation = range * 3; 
        const penalty = Math.min(1, distance / max_deviation) * 0.7; 
        return 1.2 - penalty;
    };

    const getFinalMultiplier = (fishName, temp, pressure, windSpeed, waveHeight) => {
        const ideal = IDEAL_KOÅULLAR[fishName];
        if (!ideal) return 1.0; 

        let totalMultiplier = 0;
        let totalWeight = 0;

        const factors = [
            { current: temp, ideal: ideal.temp, weight: ideal.weightT },
            { current: pressure, ideal: ideal.pressure, weight: ideal.weightP },
            { current: windSpeed, ideal: ideal.windSpeed, weight: ideal.weightW },
            { current: waveHeight, ideal: ideal.waveHeight, weight: ideal.weightH }
        ];

        factors.forEach(f => {
            const factorM = calculateFactorMultiplier(f.current, f.ideal);
            totalMultiplier += factorM * f.weight;
            totalWeight += f.weight;
        });
        
        return totalMultiplier / totalWeight; 
    };

    const getSolunarBaseScore = (m1, m2, n1, n2) => {
        let totalWeight = 0;
        for (let i = 0; i < 24; i++) {
            totalWeight += getFishEmojis(i + 0.5, m1, m2, n1, n2, true);
        }
        const averageScore = (totalWeight / 72) * 100;
        return Math.min(100, Math.round(averageScore)); 
    };

    const getScoreStatus = (score) => {
        let status = "", className = "";
        if (score > 80) {status = "Ã‡OK YÃœKSEK"; className = "cok-yuksek";} 
        else if (score > 60) {status = "YÃœKSEK"; className = "yuksek";} 
        else if (score > 35) {status = "ORTA"; className = "orta";} 
        else {status = "DÃœÅÃœK"; className = "dÃ¼ÅŸÃ¼k";}
        return { status, className };
    };

    const grafik = (m1, m2, n1, n2) => {
        let h = `<div class="grafik-konteyner"><div class="grafik">`;
        for (let i = 0; i < 24; i++) {
            const emoji = getFishEmojis(i + 0.5, m1, m2, n1, n2);
            h += `<div class="emoji-container">${emoji}</div>`;
        }
        h += `</div><div class="saatlik-grid">`;
        for (let i = 0; i < 24; i++) {
            const etiket = i.toString().padStart(2, "0"); 
            h += `<div class="saat-etiket-sutun">${etiket}</div>`;
        }
        h += `</div></div>`;
        return h;
    };

    // BalÄ±k KartlarÄ±nÄ± OluÅŸturma Fonksiyonu
    const renderFishCards = (teknikler, solunarTabanPuan, suSicakligi, basinc, ruzgarHizi, dalgaBoyu) => {
        let baliklarHTML = '';
        let overallScoreSum = 0;
        let fishCount = 0;
        // IDEAL_KOÅULLAR'da tanÄ±mlÄ± olan tÃ¼rler puanlamaya dahil edilir.
        const puanlananTurler = Object.keys(IDEAL_KOÅULLAR);

        puanlananTurler.forEach(b => {
            const cevreselCarpan = getFinalMultiplier(b, suSicakligi, basinc, ruzgarHizi, dalgaBoyu);
            let nihaiPuan = Math.round(solunarTabanPuan * cevreselCarpan);
            nihaiPuan = Math.max(0, Math.min(100, nihaiPuan)); 
            
            const { status, className } = getScoreStatus(nihaiPuan);

            baliklarHTML += `<div class="balik" onclick="window.app.acTeknik('${b}')">
                                <h3>${b}</h3>
                                <div class="durum ${className}">${status} (${nihaiPuan}%)</div>
                            </div>`;
            
            overallScoreSum += nihaiPuan;
            fishCount++;
        });
        
        const genelAvPuan = fishCount > 0 ? Math.round(overallScoreSum / fishCount) : solunarTabanPuan;
        return { baliklarHTML, genelAvPuan };
    };


    // Ana GÃ¼ncelleme Fonksiyonu
    async function guncelle(l = lat, n = lon) {
        document.body.classList.add("loading");
        
        const today = new Date();
        const isoDate = today.toISOString().split('T')[0];
        
        const tarihInput = document.getElementById("tarihInput");
        const iso = tarihInput && tarihInput.value ? tarihInput.value : isoDate;
        tarih = new Date(iso);

        // YÃœKLEME VE TARÄ°H BÄ°LGÄ°SÄ°
        document.getElementById("info").innerHTML = `
            <div class="konum">ğŸ“ Konum YÃ¼kleniyor...</div>
            <input type="date" id="tarihInput" value="${iso}" onchange="window.app.tarihInputChanged(this.value)">
            <div style="text-align:center; padding:50px 0; font-size:24px; color:#00ff9d;">Veriler YÃ¼kleniyor... â³</div>
        `;
        lat = l; lon = n; 
        marker.setLatLng([l, n]); 
        map.setView([l, n], 13);

        try {
            // API CALLS
            const [yerRes, havaRes, denizRes, gunRes] = await Promise.all([
                fetch(`https://nominatim.openstreetmap.org/reverse?lat=${l}&lon=${n}&format=json`).then(r => r.json()),
                fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${l}&lon=${n}&appid=${API_KEY}&units=metric&lang=tr`).then(r => r.json()),
                fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${l}&longitude=${n}&hourly=wave_height,sea_surface_temperature&timezone=Europe%2FIstanbul&start_date=${iso}&end_date=${iso}`).then(r => r.json()),
                fetch(`https://api.sunrise-sunset.org/json?lat=${l}&lng=${n}&date=${iso}&formatted=0`).then(r => r.json())
            ]);

            // Veri Ä°ÅŸleme
            const yerAdi = yerRes.address.city || yerRes.address.town || yerRes.address.village || yerRes.display_name.split(",")[0];
            
            const targetHour = new Date(iso).setHours(12);
            const gun = havaRes.list.reduce((prev, curr) => {
                const timeDiffPrev = Math.abs(new Date(prev.dt_txt).getTime() - targetHour);
                const timeDiffCurr = Math.abs(new Date(curr.dt_txt).getTime() - targetHour);
                return (timeDiffCurr < timeDiffPrev) ? curr : prev;
            });

            const suSicakligi = parseFloat(denizRes.hourly?.sea_surface_temperature?.[12]?.toFixed(1) ?? "15.0"); 
            const dalgaBoyu = parseFloat(denizRes.hourly?.wave_height?.[12]?.toFixed(1) ?? "0.5");
            const basinc = gun.main.pressure;
            const ruzgarHizi = gun.wind.speed;
            
            const gunDogus = new Date(gunRes.results.sunrise).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            const gunBatis = new Date(gunRes.results.sunset).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

            const { maj1, maj2, min1, min2, ay } = solunar(tarih);
            const { seviye, trend } = gelgit(tarih);
            
            const majorSaatler = `${formatSolunarTime(maj1)} & ${formatSolunarTime(maj2)}`;
            const minorSaatler = `${formatSolunarTime(min1)} & ${formatSolunarTime(min2)}`;

            const solunarTabanPuan = getSolunarBaseScore(maj1, maj2, min1, min2); 

            // BalÄ±k TÃ¼rlerine Ã–zel Puanlama
            const { baliklarHTML, genelAvPuan } = renderFishCards(teknikler, solunarTabanPuan, suSicakligi, basinc, ruzgarHizi, dalgaBoyu);
            const genelStatus = getScoreStatus(genelAvPuan);
            
            // HTML Ã‡Ä±ktÄ±sÄ±
            document.getElementById("info").innerHTML = `
                <div class="konum">ğŸ“ ${yerAdi}</div>
                <input type="date" id="tarihInput" value="${iso}" onchange="window.app.tarihInputChanged(this.value)">

                <div class="solunar">
                    <h3>SOLUNAR AKTÄ°VÄ°TE TABLOSU (24 Saat)</h3>
                    ${grafik(maj1, maj2, min1, min2)}
                </div>

                <div class="ortalama-puan-kutu">
                    <span>SEÃ‡Ä°LEN GÃœNÃœN TAHMÄ°NÄ° GENEL AV PUANI (${Object.keys(IDEAL_KOÅULLAR).length} TÃ¼r OrtalamasÄ±)</span>
                    <strong>${genelAvPuan}% (${genelStatus.status})</strong>
                </div>
                
                <div class="karti solunar-zaman">
                    <div style="font-size:18px; color:#00ff9d; font-weight:900; margin-bottom:10px; text-align:center;">KRÄ°TÄ°K AVLANMA ZAMANLARI (Yerel Saat)</div>
                    <div class="grid">
                        <div class="item"><strong>${majorSaatler}</strong><br>Major DÃ¶nemler (En YÃ¼ksek)</div>
                        <div class="item"><strong>${minorSaatler}</strong><br>Minor DÃ¶nemler (YÃ¼ksek)</div>
                    </div>
                </div>

                <div class="karti"><div class="grid">
                    <div class="item"><strong>${Math.round(gun.main.temp)}Â°C</strong><br>Hava SÄ±caklÄ±ÄŸÄ±</div>
                    <div class="item"><strong>${basinc} hPa</strong><br>BasÄ±nÃ§</div>
                    <div class="item"><strong>${yon(gun.wind.deg)} ${ruzgarHizi.toFixed(1)} m/s</strong><br>RÃ¼zgar</div>
                    <div class="item"><strong>${gun.weather[0].description.charAt(0).toUpperCase() + gun.weather[0].description.slice(1)}</strong><br>Hava</div>
                </div></div>

                <div class="karti deniz"><div class="grid">
                    <div class="item"><strong>${suSicakligi}Â°C</strong><br>Su SÄ±caklÄ±ÄŸÄ±</div>
                    <div class="item"><strong>${dalgaBoyu} m</strong><br>Dalga</div>
                    <div class="item"><strong>${gunDogus} / ${gunBatis}</strong><br>GÃ¼neÅŸ D/B</div>
                    <div class="item"><strong>${ay}%</strong><br>Ay Doluluk</div>
                </div></div>
                
                <div class="karti"><div class="grid">
                    <div class="item" style="grid-column: span 2;"><strong>${trend} ${seviye} m</strong><br>Gelgit / AkÄ±ntÄ± Durumu (Karadeniz SimÃ¼lasyonu)</div>
                </div></div>

                <div id="teknik" class="teknik"></div>

                <div style="text-align:center;margin:40px 0 20px;color:#00ff9d;font-size:22px;font-weight:900">ğŸ  BALIK TÃœRÃœNE GÃ–RE AV BAÅARI PUANI (BÃ¶lgesel) ğŸ¯</div>
                <div class="balik-grid">${baliklarHTML}</div>
            `;

            document.body.classList.remove("loading");

        } catch (error) {
            console.error("KRÄ°TÄ°K HATA: API VERÄ°SÄ° Ã‡EKÄ°LEMEDÄ°! LÃ¼tfen API AnahtarÄ±nÄ±zÄ± kontrol edin.", error); 
            
            document.getElementById("info").innerHTML = `
                <div class="konum" style="color:#ff2600;">âŒ VERÄ° HATASI!</div>
                <input type="date" id="tarihInput" value="${iso}" onchange="window.app.tarihInputChanged(this.value)">
                <div style="text-align:center; padding:50px 0; color:#ffc107;">
                    <h2>API BaÄŸlantÄ± HatasÄ±! ğŸ›‘</h2>
                    <p>Veriler yÃ¼klenemedi. LÃ¼tfen **GeliÅŸtirici Konsolunu (F12)** kontrol edin ve **API AnahtarÄ±nÄ±zÄ±n** (OpenWeatherMap) geÃ§erli olduÄŸundan emin olun.</p>
                </div>
            `;
            document.body.classList.remove("loading");
        }
    }

    // Teknik Detay gÃ¶sterici (Global eriÅŸim iÃ§in)
    function acTeknik(b) {
        const el = document.getElementById("teknik");
        el.innerHTML = teknikler[b];
        el.classList.add("active");
        el.scrollIntoView({ behavior: "smooth" });
    }

    // Tarih DeÄŸiÅŸimi Fonksiyonu
    function tarihInputChanged(dateValue) {
        tarih = new Date(dateValue);
        guncelle(lat, lon);
    }

    // Uygulama BaÅŸlatma Fonksiyonu
    function init() {
        // Harita Kurulumu
        map = L.map('map').setView(BARTIN, 11);
        marker = L.marker(BARTIN, { draggable: true }).addTo(map); 

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        // Olay Dinleyicileri
        debouncedGuncelle = debounce(guncelle, 500);

        marker.on('dragend', (e) => {
            const coords = e.target.getLatLng();
            debouncedGuncelle(coords.lat.toFixed(5), coords.lng.toFixed(5));
        });

        map.on("click", e => debouncedGuncelle(e.latlng.lat.toFixed(5), e.latlng.lng.toFixed(5)));
        
        guncelle(lat, lon); // Ä°lk yÃ¼kleme
    }
    
    // Global eriÅŸim iÃ§in fonksiyonlarÄ± window objesine ata
    window.app = {
        init: init,
        acTeknik: acTeknik,
        tarihInputChanged: tarihInputChanged
    };

    window.onload = window.app.init;
})();
</script>
</body>
</html>
