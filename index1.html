<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BalÄ±k AvÄ± Rehberi</title>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  body,html{height:100%;background:#0c1e36;color:#fff;font-family:system-ui,sans-serif;overflow:hidden}
  .header{background:#00ff9d;color:#000;padding:16px;font-weight:900;text-align:center;position:fixed;top:0;left:0;right:0;z-index:1000;box-shadow:0 4px 10px rgba(0,255,157,.5);font-size:20px}
  #map{height:35vh;width:100%;position:relative;top:52px}
  .content{position:absolute;top:calc(35vh + 52px);left:0;right:0;bottom:0;overflow-y:auto;background:#0c1e36}
  .card{background:rgba(255,255,255,.08);backdrop-filter:blur(16px);border-radius:20px 20px 0 0;margin:0;padding:20px 16px 40px;box-shadow:0 -10px 40px rgba(0,0,0,.7)}
  .konum{font-size:24px;color:#00ff9d;font-weight:900;margin-bottom:8px;text-shadow:0 0 12px #00ff9d}
  input[type=date]{width:270px;padding:14px 20px;font-size:19px;border:none;border-radius:16px;background:#16213e;color:#fff;box-shadow:0 6px 25px #0008;display:block;margin:10px auto 16px}
  .solunar{background:#16213e;padding:20px;border-radius:18px;margin:18px 0}
  .solunar h3{font-size:20px;color:#00ff9d;font-weight:900;text-align:center;margin-bottom:16px}
  .grafik-konteyner{border:1px solid rgba(255,255,255,.1);border-radius:12px;background:#0b1a2e;margin-bottom:20px;display:flex;flex-direction:column}
  .grafik{height:60px;overflow:hidden;padding:10px 0;display:flex;justify-content:space-around}
  .emoji-container{flex:1;text-align:center;font-size:14px;line-height:40px}
  .saatlik-grid{display:grid;grid-template-columns:repeat(24,1fr);gap:0;height:25px;text-align:center;background:rgba(255,255,255,.05);border-top:1px solid rgba(255,255,255,.1);border-radius:0 0 12px 12px}
  .saat-etiket-sutun{font-size:9px;line-height:25px;opacity:0.8;border-right:1px solid rgba(255,255,255,.2)}
  .saat-etiket-sutun:last-child{border:none}
  .ortalama-puan-kutu{background:rgba(0,255,157,.1);border-radius:12px;padding:15px;text-align:center;margin:20px 0;border:1px solid #00ff9d}
  .ortalama-puan-kutu strong{display:block;font-size:36px;color:#00ff9d;font-weight:900}
  .karti{padding:18px;border-radius:18px;margin:18px 0;background:linear-gradient(135deg,#1e3c72,#2a5298)}
  .karti.deniz{background:linear-gradient(135deg,#0f2027,#203a43)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;text-align:center}
  .item{background:rgba(255,255,255,.12);padding:14px;border-radius:14px}
  .item strong{font-size:21px;display:block}
  .balik-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:30px 0}
  .balik{background:#16213e;padding:16px;border-radius:16px;text-align:center;cursor:pointer;transition:.3s;border:1px solid rgba(0,255,157,.15)}
  .balik:hover{transform:scale(1.1);background:#1e2d4a;box-shadow:0 10px 30px rgba(0,255,157,.4)}
  .balik h3{margin:0 0 6px;font-size:16px;color:#00ff9d}
  .durum{font-size:15px;font-weight:900}
  .cok-yuksek{color:#ff2600}.yuksek{color:#00ff9d}.orta{color:#ffc107}.dÃ¼ÅŸÃ¼k{color:#b3b3b3}
  .teknik{display:none;background:#0a1e33;padding:30px;border-radius:24px;margin:30px 0;border:3px solid #00ff9d66;line-height:2.2;font-size:17px}
  .teknik.active{display:block}
  .teknik .baslik{font-size:28px;color:#00ff9d;font-weight:900;display:block;margin-bottom:20px;text-align:center}
  .tahmin-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:20px;padding:15px;background:rgba(0,0,0,.2);border-radius:18px}
  .tahmin-gun{background:rgba(255,255,255,.1);padding:10px 5px;border-radius:10px;text-align:center;font-size:14px;border:1px solid rgba(255,255,255,.1);cursor:pointer;}
  .tahmin-gun .gun-adi{font-weight:700;color:#00ff9d;margin-bottom:5px;font-size:12px}
  .loading .card{opacity:0.5;pointer-events:none}
  
  /* YENÄ°: SÄ±ralama Penceresi (Overlay) Stilleri */
  .ranking-overlay {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #16213e;
    border: 3px solid #00ff9d;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 0 40px rgba(0, 255, 157, 0.5);
    z-index: 2000;
    width: 90%;
    max-width: 350px;
    display: none; 
    color: #fff;
  }
  .ranking-overlay h3 {
    color: #00ff9d;
    margin-bottom: 15px;
    font-size: 20px;
    text-align: center;
  }
  .ranking-overlay ul {
    list-style: none;
    padding: 0;
  }
  .ranking-overlay li {
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    font-weight: 700;
  }
  .close-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 24px;
    cursor: pointer;
    color: #ff2600;
  }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
</head>
<body>

<div class="header">BalÄ±k AvÄ± Rehberi ğŸŸ</div>
<div id="map"></div>
<div class="content"><div class="card" id="info">
  <div style="text-align:center;padding:120px 0;font-size:24px;color:#00ff9d;">Veriler yÃ¼kleniyor... â³</div>
</div></div>

<div id="rankingOverlay" class="ranking-overlay"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
// â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€
// LÃœTFEN BURAYA KENDÄ° OPENWEATHERMAP ANAHTARINI YAZ (Ã¼cretsiz)
// https://home.openweathermap.org/users/sign_up adresinden 1 dakikada alabilirsin
// â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€9â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€
const API_KEY = "13dda88cd89bad8dfb00130704d2d2e4";  // â† Kendi anahtarÄ±nÄ±zÄ± buraya koyun!

let lat = 41.634, lon = 32.335;
let map, marker, tarih = new Date();
let gunlukBalikSiralamasi = {}; // YENÄ°: GÃ¼nlÃ¼k balÄ±k sÄ±ralamasÄ±nÄ± saklamak iÃ§in

// YENÄ° ÅABLON: Global AÄŸÄ±rlÄ±klar (Wi)
const GLOBAL_AGIRLIKLAR = {
  SST: 30, // Su SÄ±caklÄ±ÄŸÄ±
  BP: 25,  // BasÄ±nÃ§
  RW: 15,  // RÃ¼zgar & Dalga
  SA: 10,  // Solunar Zamanlama
  ML: 10,  // Ay Evresi
  DE: 10   // DiÄŸer Etkenler (Yem, BerraklÄ±k - VarsayÄ±lan 80 Puan)
};


// BalÄ±k TÃ¼rleri ve Ä°deal KoÅŸullarÄ± (Sadece ideal aralÄ±klar tutuldu, yeni ÅŸablona gÃ¶re)
const IDEAL_KOÅULLAR = {
  // [SST_min, SST_max], [RW_min, RW_max] (Dalga Boyu m), [BP_min, BP_max] (hPa)
  "LÃ¼fer":{temp:[13,17], pressure:[1010,1025], waveHeight:[0.2,0.8]},
  "Levrek":{temp:[14,18], pressure:[1005,1018], waveHeight:[0.3,1.0]},
  "Ä°stavrit":{temp:[12,20], pressure:[1015,1030], waveHeight:[0.3,0.8]},
  "Mezgit":{temp:[4,12], pressure:[1010,1025], waveHeight:[0.5,1.5]},
  "Kalkan":{temp:[5,12], pressure:[1008,1020], waveHeight:[0.0,0.5]},
  "Zargana":{temp:[18,24], pressure:[1010,1022], waveHeight:[0.0,0.1]},
  "SarÄ±kanat":{temp:[13,17], pressure:[1010,1025], waveHeight:[0.2,0.8]},
  "Kefal":{temp:[17,22], pressure:[1015,1030], waveHeight:[0.0,0.3]},
  "Barbun":{temp:[14,20], pressure:[1008,1020], waveHeight:[0.0,0.5]},
  "Ä°zmarit":{temp:[10,18], pressure:[1010,1025], waveHeight:[0.0,0.5]},
  "Sargoz":{temp:[16,24], pressure:[1005,1018], waveHeight:[0.5,1.5]},
  "KÄ±rlangÄ±Ã§":{temp:[8,16], pressure:[1010,1025], waveHeight:[0.5,1.5]}
};

// BalÄ±k TÃ¼rleri ve Avlanma Teknikleri (DeÄŸiÅŸmedi)
const teknikler = {
  "LÃ¼fer":`<span class="baslik">LÃœFER â€“ AT-Ã‡EK & SPÄ°N</span><strong>Ekipman:</strong> 270-300 cm MH kamÄ±ÅŸ, 3000-4000 makine, 0.12-0.16 ip + 0.30-0.35 FC lider<br><strong>Yem:</strong> 9-14 cm minnow, popper, kaÅŸÄ±k â€¢ Aksiyon: HÄ±zlÄ± sarÄ±m + ani duraksama`,
  "Levrek":`<span class="baslik">LEVREK â€“ YÃœZEY & SÄ°LÄ°KON</span><strong>Ekipman:</strong> 240-270 cm L-ML kamÄ±ÅŸ, 2500-3000 makine<br><strong>Yem:</strong> Popper, walker, silikon, canlÄ± karides`,
  "Ä°stavrit":`<span class="baslik">Ä°STAVRÄ°T â€“ Ã‡APARÄ°</span><strong>Yem:</strong> Beyaz/sarÄ± tÃ¼ylÃ¼ sabiki, midye iÃ§i`,
  "Mezgit":`<span class="baslik">MEZGÄ°T â€“ JIG & DÄ°P</span><strong>Yem:</strong> 30-80 gr metal jig, hamsi parÃ§asÄ±`,
  "Kalkan":`<span class="baslik">KALKAN â€“ PARAKETE</span><strong>Yem:</strong> Ä°ri palamut/mezgit filetosu`,
  "Zargana":`<span class="baslik">ZARGANA â€“ ÅAMANDIRA</span><strong>Yem:</strong> Ä°pek, deniz kurdu`,
  "SarÄ±kanat":`<span class="baslik">SARIKANAT â€“ JIG</span><strong>Yem:</strong> 5-9 cm silikon/minnow`,
  "Kefal":`<span class="baslik">KEFAL â€“ EKMEK AVI</span><strong>Yem:</strong> Ekmek hamuru, karides`,
  "Barbun":`<span class="baslik">BARBUN â€“ DÄ°P</span><strong>Yem:</strong> Boru kurdu, karides`,
  "Ä°zmarit":`<span class="baslik">Ä°ZMARÄ°T â€“ EL OLTASI</span><strong>Yem:</strong> Midye iÃ§i`,
  "Sargoz":`<span class="baslik">SARGOZ â€“ SURFCASTING</span><strong>KamÄ±ÅŸ:</strong> 4-4.5 m 100-200 gr`,
  "KÄ±rlangÄ±Ã§":`<span class="baslik">KIRLANGIÃ‡ â€“ DERÄ°N DÄ°P</span><strong>Yem:</strong> CanlÄ± hamsi, kalamar`
};

// --- YARDIMCI FONKSÄ°YONLAR ---
const yon = d => ["K","KB","B","GB","G","GD","D","KD"][Math.round(d / 45) % 8] || "K";
const formatSolunarTime = h => {
  const hours = Math.floor(h).toString().padStart(2, '0');
  const minutes = Math.round((h - Math.floor(h)) * 60).toString().padStart(2, '0');
  return `${hours}:${minutes}`;
};
const solunar = t => {
  const g = (t - new Date("2000-01-06")) / 864e5;
  const m = (218.316 + 13.176396 * g) % 360;
  const s = (280.466 + 0.9856474 * ((t - new Date("2000-01-01")) / 864e5)) % 360;
  let f = (m - s + 360) % 360;
  if (f > 180) f -= 360;
  const maj1 = ((f / 15) + 2 + 24) % 24; const maj2 = (maj1 + 12) % 24;
  const min1 = (maj1 + 6) % 24; const min2 = (maj1 + 18) % 24;
  return { maj1, maj2, min1, min2, ay: Math.round((f + 180) / 3.6) };
};
const getFishEmojis = (hour, m1, m2, n1, n2, returnWeight = false) => {
  let count = 0;
  if (Math.abs(hour - m1) < 1.5 || Math.abs(hour - m2) < 1.5) count = 3;
  else if (Math.abs(hour - n1) < 1 || Math.abs(hour - n2) < 1) count = 2;
  else if (Math.abs(hour - n1) < 2 || Math.abs(hour - n2) < 2) count = 1;
  if (returnWeight) return count;
  if (count === 3) return "ğŸŸğŸŸğŸŸ";
  if (count === 2) return "ğŸŸğŸŸ";
  if (count === 1) return "ğŸŸ";
  return "";
};
const getSolunarBaseScore = (m1, m2, n1, n2) => {
  let totalWeight = 0;
  for (let i = 0; i < 24; i++) {
    totalWeight += getFishEmojis(i + 0.5, m1, m2, n1, n2, true);
  }
  const averageScore = (totalWeight / 72) * 100;
  return Math.min(100, Math.round(averageScore));
};

// YENÄ° ÅABLON FONKSÄ°YONLARI

// 1. SST, BP, RW faktÃ¶rleri iÃ§in 0-100 arasÄ± puan hesaplar (Pi)
const getFactorScore = (current, idealRange) => {
  const [min, max] = idealRange;
  if (current >= min && current <= max) return 100;

  const midpoint = (min + max) / 2;
  const range = (max - min) / 2;
  const distance = Math.abs(current - midpoint);

  const max_deviation = range * 3;

  if (distance > max_deviation) return 0;

  const score = 100 * (1 - (distance / max_deviation));
  return Math.max(0, Math.round(score));
};

// 2. ML FaktÃ¶r PuanÄ± (Ay Doluluk %'si - Pi)
const getMoonScore = (ayDoluluk) => {
  const score = 100 - (ayDoluluk * 0.8);
  return Math.max(20, Math.round(score));
};


// 3. Nihai AÄŸÄ±rlÄ±klÄ± Puan Hesaplama Fonksiyonu (TÃ¼re Ã–zel)
const calculateWeightedScore = (fishName, currentTemp, currentPressure, currentWave, solunarBaseScore, moonFullness) => {
    const ideal = IDEAL_KOÅULLAR[fishName];
    const AGIRLIKLAR = GLOBAL_AGIRLIKLAR;

    let totalWeightedScore = 0;

    const scoreSST = getFactorScore(currentTemp, ideal.temp);
    totalWeightedScore += (scoreSST * AGIRLIKLAR.SST) / 100;

    const scoreBP = getFactorScore(currentPressure, ideal.pressure);
    totalWeightedScore += (scoreBP * AGIRLIKLAR.BP) / 100;

    const scoreRW = getFactorScore(currentWave, ideal.waveHeight);
    totalWeightedScore += (scoreRW * AGIRLIKLAR.RW) / 100;

    const scoreSA = solunarBaseScore;
    totalWeightedScore += (scoreSA * AGIRLIKLAR.SA) / 100;

    const scoreML = getMoonScore(moonFullness);
    totalWeightedScore += (scoreML * AGIRLIKLAR.ML) / 100;

    const scoreDE = 80; 
    totalWeightedScore += (scoreDE * AGIRLIKLAR.DE) / 100;

    return Math.round(totalWeightedScore);
};

// 4. Genel Av PuanÄ± Hesaplama (TÃ¼r ortalamasÄ± olmadan, Ã§evresel potansiyel)
const getOverallEnvironmentalScore = (suSicakligi, basinc, dalgaBoyu, solunarBaseScore, moonFullness) => {
    const AGIRLIKLAR = GLOBAL_AGIRLIKLAR;
    let totalWeightedScore = 0;
    
    // GeniÅŸ/Ortalama Ä°deal AralÄ±ÄŸÄ± kullanÄ±lÄ±r:
    
    // 1. SST (Genel BalÄ±kÃ§Ä±lÄ±k Ä°Ã§in Ä°deal SÄ±caklÄ±k: 14Â°C - 20Â°C)
    const scoreSST = getFactorScore(suSicakligi, [14, 20]); 
    totalWeightedScore += (scoreSST * AGIRLIKLAR.SST) / 100;

    // 2. BP (Genel KararlÄ±lÄ±k AralÄ±ÄŸÄ±: 1010 hPa - 1025 hPa)
    const scoreBP = getFactorScore(basinc, [1010, 1025]);
    totalWeightedScore += (scoreBP * AGIRLIKLAR.BP) / 100;

    // 3. RW (Hafif Ã‡alkantÄ±: 0.3m - 1.0m)
    const scoreRW = getFactorScore(dalgaBoyu, [0.3, 1.0]);
    totalWeightedScore += (scoreRW * AGIRLIKLAR.RW) / 100;

    // 4. SA 
    const scoreSA = solunarBaseScore;
    totalWeightedScore += (scoreSA * AGIRLIKLAR.SA) / 100;

    // 5. ML
    const scoreML = getMoonScore(moonFullness);
    totalWeightedScore += (scoreML * AGIRLIKLAR.ML) / 100;

    // 6. DiÄŸer Etkenler (VarsayÄ±lan 80)
    const scoreDE = 80; 
    totalWeightedScore += (scoreDE * AGIRLIKLAR.DE) / 100;

    return Math.round(totalWeightedScore);
};
// YENÄ° ÅABLON FONKSÄ°YONLARI SONU

const getScoreStatus = (score) => {
  if (score > 80) return { status: "Ã‡OK YÃœKSEK", className: "cok-yuksek" };
  if (score > 60) return { status: "YÃœKSEK", className: "yuksek" };
  if (score > 35) return { status: "ORTA", className: "orta" };
  return { status: "DÃœÅÃœK", className: "dÃ¼ÅŸÃ¼k" };
};
const grafik = (m1, m2, n1, n2) => {
  let h = `<div class="grafik-konteyner"><div class="grafik">`;
  for (let i = 0; i < 24; i++) {
    const emoji = getFishEmojis(i + 0.5, m1, m2, n1, n2);
    h += `<div class="emoji-container">${emoji}</div>`;
  }
  h += `</div><div class="saatlik-grid">`;
  for (let i = 0; i < 24; i++) {
    h += `<div class="saat-etiket-sutun">${i.toString().padStart(2,"0")}:00</div>`;
  }
  return h + `</div></div>`;
};


const renderFishCards = (solunarTabanPuan, suSicakligi, basinc, ruzgarHizi, dalgaBoyu, ayDoluluk) => {
  let baliklarHTML = '';
  const puanlananTurler = Object.keys(IDEAL_KOÅULLAR);

  puanlananTurler.forEach(b => {
    let nihaiPuan = calculateWeightedScore(
        b, 
        suSicakligi, 
        basinc, 
        dalgaBoyu, 
        solunarTabanPuan, 
        ayDoluluk
    );
    
    nihaiPuan = Math.max(0, Math.min(100, nihaiPuan));
    const { status, className } = getScoreStatus(nihaiPuan);
    baliklarHTML += `<div class="balik" onclick="window.app.acTeknik('${b}')">
                        <h3>${b}</h3>
                        <div class="durum ${className}">${status} (${nihaiPuan}%)</div>
                    </div>`;
  });
  return { baliklarHTML };
};

// 5 GÃ¼nlÃ¼k Tahmin Hesaplama ve Render Fonksiyonu GÃœNCELLENDÄ°
const render5GunlukTahmin = (havaVerisi, denizVerisi) => {
    const tahminler = {};
    const turSayisi = Object.keys(IDEAL_KOÅULLAR).length;
    const todayISO = new Date().toISOString().split('T')[0];

    // TEMÄ°ZLÄ°K: GÃ¼nlÃ¼k balÄ±k sÄ±ralamasÄ±nÄ± sÄ±fÄ±rla
    gunlukBalikSiralamasi = {}; 

    havaVerisi.list.forEach(item => {
        const dt = new Date(item.dt_txt);
        const key = dt.toISOString().split('T')[0];
        
        if (new Date(key) < new Date(todayISO) || Object.keys(tahminler).length >= 5) return;

        const temp = item.main.temp;
        const pressure = item.main.pressure;
        
        const { maj1, maj2, min1, min2, ay } = solunar(dt); 
        const solunarTabanPuan = getSolunarBaseScore(maj1, maj2, min1, min2);

        const denizIndex = denizVerisi.hourly.time.findIndex(t => t.startsWith(key + "T12:00"));
        const dalgaBoyu = denizIndex !== -1 ? denizVerisi.hourly.wave_height[denizIndex] || 0.5 : 0.5;
        const suSicakligi = denizIndex !== -1 ? denizVerisi.hourly.sea_surface_temperature[denizIndex] || 15.0 : 15.0;

        let gunlukFishScores = []; 
        let gunlukAvPuan = 0;
        
        Object.keys(IDEAL_KOÅULLAR).forEach(b => {
            let nihaiPuan = calculateWeightedScore(b, suSicakligi, pressure, dalgaBoyu, solunarTabanPuan, ay);
            nihaiPuan = Math.max(0, Math.min(100, nihaiPuan)); 
            gunlukAvPuan += nihaiPuan;
            gunlukFishScores.push({ name: b, score: nihaiPuan });
        });
        
        const saatlikAvPuan = gunlukAvPuan / turSayisi;

        if (!tahminler[key]) {
            tahminler[key] = { puanlar: [], tarih: dt, fishScores: [] };
        }
        tahminler[key].puanlar.push(saatlikAvPuan);
        tahminler[key].fishScores.push(gunlukFishScores);
    });
    
    let tahminHTML = `<div style="text-align:center;margin:30px 0 15px;color:#fff;font-size:18px;font-weight:700">ğŸ—“ï¸ Ã–NÃœMÃœZDEKÄ° 5 GÃœNLÃœK GENEL AV TAHMÄ°NÄ°</div><div class="tahmin-grid">`;
    const gunler = ["Paz", "Pzt", "Sal", "Ã‡ar", "Per", "Cum", "Cmt"];
    let sayac = 0;

    for (const key in tahminler) {
        if (sayac >= 5) break; 
        const tahmin = tahminler[key];

        const validPuanlar = tahmin.puanlar.filter(p => !isNaN(p));
        // undefined hatasÄ±nÄ± Ã¶nlemek iÃ§in kontrol eklendi
        const ortalamaPuan = validPuanlar.length > 0 ? Math.round(validPuanlar.slice(0, 8).reduce((a, b) => a + b, 0) / Math.min(validPuanlar.length, 8)) : 0;
        
        // GÃ¼nlÃ¼k En Ä°yi BalÄ±k SkorlarÄ±nÄ± Hesaplama (TÃ¼m 3 saatlik skorlarÄ±n ortalamasÄ±nÄ± al)
        const dailyAverageFishScores = {};
        tahminler[key].fishScores.flat().forEach(fish => {
            if (!dailyAverageFishScores[fish.name]) dailyAverageFishScores[fish.name] = { total: 0, count: 0 };
            dailyAverageFishScores[fish.name].total += fish.score;
            dailyAverageFishScores[fish.name].count += 1;
        });

        let finalRanking = Object.keys(dailyAverageFishScores).map(name => ({
            name: name,
            score: Math.round(dailyAverageFishScores[name].total / dailyAverageFishScores[name].count)
        }));

        finalRanking.sort((a, b) => b.score - a.score);
        gunlukBalikSiralamasi[key] = finalRanking.slice(0, 5); 

        
        const { status, className } = getScoreStatus(ortalamaPuan);
        const gunAdi = sayac === 0 && key === todayISO ? "BugÃ¼n" : gunler[tahmin.tarih.getDay()];

        tahminHTML += `
            <div class="tahmin-gun" onclick="window.app.showDailyFishRanking('${key}')"> 
                <div class="gun-adi">${gunAdi}</div>
                <div class="puan-yuzde ${className}">${ortalamaPuan}%</div>
                <div class="${className}" style="font-size:10px;">(${status.status})</div>
            </div>
        `;
        sayac++;
    }
    
    tahminHTML += `</div>`;
    return tahminHTML;
};

// YENÄ° FONKSÄ°YON: GÃ¼nlÃ¼k balÄ±k sÄ±ralamasÄ±nÄ± aÃ§ar
function showDailyFishRanking(dateKey) {
    const ranking = gunlukBalikSiralamasi[dateKey];
    const overlay = document.getElementById('rankingOverlay');
    const today = new Date().toISOString().split('T')[0];
    const headerDate = dateKey === today ? "BugÃ¼n" : new Date(dateKey).toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'long' });

    let listHTML = '<ul>';
    if (ranking && ranking.length > 0) {
        ranking.forEach((item, index) => {
            const { className } = getScoreStatus(item.score);
            listHTML += `<li>${index + 1}. ${item.name} <span class="${className}">${item.score}%</span></li>`;
        });
    } else {
        listHTML += '<li>Veri bulunamadÄ±.</li>';
    }
    listHTML += '</ul>';

    overlay.innerHTML = `
        <div class="close-btn" onclick="document.getElementById('rankingOverlay').style.display='none'">&times;</div>
        <h3>${headerDate} En Verimli BalÄ±klar ğŸ£</h3>
        ${listHTML}
    `;
    overlay.style.display = 'block';
}


// --- ANA GÃœNCELLEME FONKSÄ°YONU ---
async function guncelle(l = lat, n = lon) {
  document.body.classList.add("loading");
  document.getElementById('rankingOverlay').style.display='none'; // Overlay'i kapat

  const today = new Date();
  const isoDate = today.toISOString().split('T')[0];
  const tarihInput = document.getElementById("tarihInput");
  const iso = tarihInput && tarihInput.value ? tarihInput.value : isoDate;
  tarih = new Date(iso);

  document.getElementById("info").innerHTML = `
    <div class="konum">ğŸ“ Konum YÃ¼kleniyor...</div>
    <input type="date" id="tarihInput" value="${iso}" onchange="window.app.tarihInputChanged(this.value)">
    <div style="text-align:center; padding:50px 0; font-size:24px; color:#00ff9d;">Veriler YÃ¼kleniyor... â³</div>
  `;

  lat = l; lon = n;
  if (map && marker) {
    marker.setLatLng([l, n]);
    map.setView([l, n], 13);
  }

  try {
    const [yerRes, havaRes, denizRes, gunRes] = await Promise.all([
      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${l}&lon=${n}&format=json`).then(r => r.json()),
      fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${l}&lon=${n}&appid=${API_KEY}&units=metric&lang=tr`).then(r => r.json()),
      fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${l}&longitude=${n}&hourly=wave_height,sea_surface_temperature&timezone=Europe%2FIstanbul&start_date=${isoDate}&end_date=${new Date(new Date(isoDate).setDate(new Date(isoDate).getDate() + 5)).toISOString().split('T')[0]}`).then(r => r.json()),
      fetch(`https://api.sunrise-sunset.org/json?lat=${l}&lng=${n}&date=${iso}&formatted=0`).then(r => r.json())
    ]);

    const targetTime = new Date(iso).setHours(12, 0, 0, 0);
    const gun = havaRes.list.reduce((prev, curr) => {
      const timeDiffPrev = Math.abs(new Date(prev.dt_txt).getTime() - targetTime);
      const timeDiffCurr = Math.abs(new Date(curr.dt_txt).getTime() - targetTime);
      return (timeDiffCurr < timeDiffPrev) ? curr : prev;
    });

    const targetDate = new Date(iso + "T12:00:00");
    let closestIdx = -1;
    let minDiff = Infinity;
    denizRes.hourly.time.forEach((t, i) => {
      const timeT = new Date(t).getTime();
      if (t.startsWith(iso)) { 
          const diff = Math.abs(timeT - targetDate.getTime());
          if (diff < minDiff) {
            minDiff = diff;
            closestIdx = i;
          }
      }
    });

    const suSicakligi = closestIdx !== -1 ? parseFloat(denizRes.hourly.sea_surface_temperature[closestIdx] || 15.0) : 15.0;
    const dalgaBoyu = closestIdx !== -1 ? parseFloat(denizRes.hourly.wave_height[closestIdx] || 0.5) : 0.5;

    const yerAdi = yerRes.address ? (yerRes.address.city || yerRes.address.town || yerRes.address.village || yerRes.display_name.split(",")[0]) : "Bilinmeyen Konum";
    const basinc = gun.main.pressure;
    const ruzgarHizi = gun.wind.speed;
    const gunDogus = new Date(gunRes.results.sunrise).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
    const gunBatis = new Date(gunRes.results.sunset).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
    const { maj1, maj2, min1, min2, ay } = solunar(tarih);
    const solunarTabanPuan = getSolunarBaseScore(maj1, maj2, min1, min2);
    
    const genelAvPuan = getOverallEnvironmentalScore(
        suSicakligi, 
        basinc, 
        dalgaBoyu, 
        solunarTabanPuan, 
        ay
    );
    
    const { baliklarHTML } = renderFishCards(solunarTabanPuan, suSicakligi, basinc, ruzgarHizi, dalgaBoyu, ay);
    const genelStatus = getScoreStatus(genelAvPuan);
    
    const tahmin5GunHTML = render5GunlukTahmin(havaRes, denizRes);


    document.getElementById("info").innerHTML = `
      <div class="konum">ğŸ“ ${yerAdi}</div>
      <input type="date" id="tarihInput" value="${iso}" onchange="window.app.tarihInputChanged(this.value)">
      ${tahmin5GunHTML}
      <div class="solunar">
        <h3>SOLUNAR AKTÄ°VÄ°TE TABLOSU (24 Saat)</h3>
        ${grafik(maj1, maj2, min1, min2)}
      </div>
      <div class="ortalama-puan-kutu">
        <span>GÃœNÃœN GENEL AV POTANSÄ°YELÄ° (${Object.keys(GLOBAL_AGIRLIKLAR).length} FaktÃ¶r OrtalamasÄ±)</span>
        <strong>${genelAvPuan}% (${genelStatus.status})</strong>
      </div>
      <div class="karti solunar-zaman">
        <div style="font-size:18px; color:#00ff9d; font-weight:900; margin-bottom:10px; text-align:center;">KRÄ°TÄ°K AV ZAMANLARI</div>
        <div class="grid">
          <div class="item"><strong>${formatSolunarTime(maj1)} & ${formatSolunarTime(maj2)}</strong><br>Major DÃ¶nemler</div>
          <div class="item"><strong>${formatSolunarTime(min1)} & ${formatSolunarTime(min2)}</strong><br>Minor DÃ¶nemler</div>
        </div>
      </div>
      <div class="karti"><div class="grid">
        <div class="item"><strong>${Math.round(gun.main.temp)}Â°C</strong><br>Hava SÄ±caklÄ±ÄŸÄ±</div>
        <div class="item"><strong>${basinc} hPa</strong><br>BasÄ±nÃ§</div>
        <div class="item"><strong>${yon(gun.wind.deg || 0)} ${ruzgarHizi.toFixed(1)} m/s</strong><br>RÃ¼zgar</div>
        <div class="item"><strong>${gun.weather[0].description.charAt(0).toUpperCase() + gun.weather[0].description.slice(1)}</strong><br>Hava Durumu</div>
      </div></div>
      <div class="karti deniz"><div class="grid">
        <div class="item"><strong>${suSicakligi.toFixed(1)}Â°C</strong><br>Su SÄ±caklÄ±ÄŸÄ±</div>
        <div class="item"><strong>${dalgaBoyu.toFixed(1)} m</strong><br>Dalga YÃ¼ksekliÄŸi</div>
        <div class="item"><strong>${gunDogus} / ${gunBatis}</strong><br>GÃ¼neÅŸ DoÄŸuÅŸ/BatÄ±ÅŸ</div>
        <div class="item"><strong>${ay}%</strong><br>Ay Doluluk</div>
      </div></div>
      <div class="karti"><div class="grid">
        <div class="item" style="grid-column: span 2;"><em>Karadeniz'de gelgit etkisi Ã§ok azdÄ±r (Â±10 cm). AkÄ±ntÄ± rÃ¼zgara baÄŸlÄ±dÄ±r.</em></div>
      </div></div>
      <div id="teknik" class="teknik"></div>
      <div style="text-align:center;margin:40px 0 20px;color:#00ff9d;font-size:22px;font-weight:900">ğŸ  BALIK TÃœRÃœ BAÅARI PUANLARI ğŸ¯</div>
      <div class="balik-grid">${baliklarHTML}</div>
    `;
    document.body.classList.remove("loading");
  } catch (error) {
    console.error("KRÄ°TÄ°K HATA: API VERÄ°SÄ° Ã‡EKÄ°LEMEDÄ°!", error);
    document.getElementById("info").innerHTML = `
      <div class="konum" style="color:#ff2600;">âŒ HATA!</div>
      <input type="date" id="tarihInput" value="${iso}" onchange="window.app.tarihInputChanged(this.value)">
      <div style="text-align:center; padding:50px 0; color:#ffc107;">
        <h2>API BaÄŸlantÄ± Sorunu! ğŸ›‘</h2>
        <p>Veriler yÃ¼klenemedi. LÃ¼tfen **API AnahtarÄ±nÄ±zÄ±n** geÃ§erli olduÄŸundan ve internet baÄŸlantÄ±nÄ±zÄ±n olduÄŸundan emin olun.</p>
      </div>
    `;
    document.body.classList.remove("loading");
  }
}

function acTeknik(b) {
  const el = document.getElementById("teknik");
  el.innerHTML = teknikler[b] || "<p>Bu balÄ±k iÃ§in teknik bulunamadÄ±.</p>";
  el.classList.add("active");
  el.scrollIntoView({ behavior: "smooth" });
}

function tarihInputChanged(dateValue) {
  guncelle(lat, lon);
}

function init() {
  map = L.map('map').setView([41.634, 32.335], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  marker = L.marker([41.634, 32.335], { draggable: true }).addTo(map);

  L.Control.geocoder({
    defaultMarkGeocode: false
  }).on('markgeocode', function(e) {
    const latlng = e.geocode.center;
    marker.setLatLng(latlng);
    map.setView(latlng, 13);
    guncelle(latlng.lat, latlng.lng);
  }).addTo(map);

  marker.on('dragend', (e) => {
    const coords = e.target.getLatLng();
    guncelle(coords.lat, coords.lng);
  });

  map.on("click", e => {
    marker.setLatLng(e.latlng);
    guncelle(e.latlng.lat, e.latlng.lng);
  });

  guncelle(lat, lon);
}

window.app = {
  init: init,
  acTeknik: acTeknik,
  tarihInputChanged: tarihInputChanged,
  showDailyFishRanking: showDailyFishRanking
};
window.onload = window.app.init;
</script>
</body>
</html>
